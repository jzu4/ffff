<!DOCTYPE html>
<html dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>إزالة خلفية الصورة | أدوات تحرير الصور</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;900&display=swap');
        
        * {
            font-family: 'Tajawal', sans-serif;
        }

        :root {
            --primary-color: #8b5cf6;
            --primary-hover: #7c3aed;
            --secondary-color: #1f2937;
            --bg-color: #111827;
            --text-color: #f3f4f6;
            --card-color: #1e293b;
            --accent-color: #ec4899;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --info-color: #3b82f6;
        }
        
        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            background-image: 
                radial-gradient(circle at 25px 25px, rgba(139, 92, 246, 0.1) 2%, transparent 0%), 
                radial-gradient(circle at 75px 75px, rgba(236, 72, 153, 0.1) 2%, transparent 0%);
            background-size: 100px 100px;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: var(--primary-hover);
        }
        
        .btn-secondary {
            background-color: var(--secondary-color);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .btn-secondary:hover {
            background-color: #2d3748;
        }
        
        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #dc2626;
        }
        
        .btn-success {
            background-color: var(--success-color);
            color: white;
        }
        
        .btn-success:hover {
            background-color: #059669;
        }
        
        .card {
            background-color: var(--card-color);
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .preview-image {
            max-width: 100%;
            max-height: 500px;
            border-radius: 0.5rem;
            object-fit: contain;
        }
        
        .drop-zone {
            border: 2px dashed rgba(255, 255, 255, 0.2);
            border-radius: 1rem;
            background-color: rgba(31, 41, 55, 0.5);
            transition: all 0.3s;
        }
        
        .drop-zone:hover, .drop-zone.active {
            border-color: var(--primary-color);
            background-color: rgba(139, 92, 246, 0.1);
        }
        
        .section {
            background-color: var(--card-color);
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
            margin-bottom: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .section-title {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 1rem;
            color: var(--text-color);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .step {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .step-number {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 1rem;
        }
        
        .step-text {
            flex: 1;
        }
        
        .feature-box {
            background-color: rgba(31, 41, 55, 0.7);
            border-radius: 0.75rem;
            padding: 1.25rem;
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.3s;
        }
        
        .feature-box:hover {
            transform: translateY(-5px);
            border-color: var(--primary-color);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }
        
        .feature-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background-color: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            margin-bottom: 1rem;
        }
        
        .settings-slider {
            width: 100%;
            height: 10px;
            border-radius: 5px;
            background: #374151;
            outline: none;
            -webkit-appearance: none;
            cursor: pointer;
        }
        
        .settings-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--primary-color);
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
            border: 2px solid white;
        }
        
        .social-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 42px;
            height: 42px;
            border-radius: 50%;
            color: white;
            transition: all 0.2s;
        }
        
        .social-btn:hover {
            transform: translateY(-3px);
        }
        
        .twitter-btn {
            background-color: #1DA1F2;
        }
        
        .twitter-btn:hover {
            background-color: #0c85d0;
            box-shadow: 0 4px 8px rgba(29, 161, 242, 0.4);
        }
        
        .telegram-btn {
            background-color: #0088cc;
        }
        
        .telegram-btn:hover {
            background-color: #0077b5;
            box-shadow: 0 4px 8px rgba(0, 136, 204, 0.4);
        }
        
        .footer-link {
            color: var(--accent-color);
            text-decoration: none;
            font-weight: 600;
            transition: all 0.2s;
        }
        
        .footer-link:hover {
            color: #f472b6;
            text-decoration: underline;
        }
        
        .sticky-nav {
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
            background-color: rgba(31, 41, 55, 0.8);
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 0.5rem;
            backdrop-filter: blur(4px);
        }
        
        .loading-text {
            margin-top: 1rem;
            color: white;
            font-weight: 500;
        }
        
        .result-download-btn {
            position: absolute;
            bottom: 1rem;
            right: 1rem;
            background-color: var(--success-color);
            color: white;
            border-radius: 0.5rem;
            padding: 0.5rem 1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s;
            z-index: 10;
        }
        
        .result-download-btn:hover {
            transform: translateY(-2px);
            background-color: #059669;
            box-shadow: 0 4px 8px rgba(16, 185, 129, 0.4);
        }
        
        .result-container {
            position: relative;
            min-height: 250px;
            overflow: hidden;
            border-radius: 0.5rem;
            background-image: 
                linear-gradient(45deg, #1f2937 25%, transparent 25%), 
                linear-gradient(-45deg, #1f2937 25%, transparent 25%), 
                linear-gradient(45deg, transparent 75%, #1f2937 75%), 
                linear-gradient(-45deg, transparent 75%, #1f2937 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
            background-color: #2d3748;
        }
        
        .color-option {
            width: 32px;
            height: 32px;
            border-radius: 4px;
            cursor: pointer;
            border: 2px solid rgba(255, 255, 255, 0.2);
            transition: all 0.2s;
        }
        
        .color-option:hover, .color-option.active {
            transform: scale(1.1);
            border-color: white;
        }
        
        .color-preview {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .transparency-grid {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: -1;
        }
        
        @media (max-width: 768px) {
            .section-title {
                font-size: 1.1rem;
            }
            
            .feature-icon {
                width: 32px;
                height: 32px;
                font-size: 0.9rem;
            }
            
            .step-number {
                width: 30px;
                height: 30px;
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body class="min-h-screen p-4">
    <!-- شريط التنقل -->
    <nav class="sticky-nav shadow-lg py-3 px-4 mb-8">
        <div class="container mx-auto flex flex-wrap justify-between items-center">
            <div class="flex items-center">
                <a href="index.html" class="text-2xl font-bold flex items-center gap-2">
                    <i class="fas fa-crop-alt text-purple-500"></i>
                    <span>أدوات الصور</span>
                </a>
            </div>
            
            <div class="hidden md:flex items-center space-x-4 rtl:space-x-reverse">
                <a href="index.html" class="nav-link">الرئيسية</a>
                <a href="color-replacer.html" class="nav-link">تغيير الألوان</a>
                <a href="#" class="nav-link active">إزالة الخلفية</a>
                <a href="#" class="nav-link">المزيد من الأدوات</a>
            </div>
            
            <div>
                <a href="index.html" class="btn btn-secondary">
                    <i class="fas fa-arrow-right ml-1"></i>
                    العودة للرئيسية
                </a>
            </div>
        </div>
    </nav>

    <div class="container mx-auto">
        <!-- العنوان -->
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-black mb-3">إزالة خلفية الصورة</h1>
            <p class="text-xl text-gray-400 max-w-3xl mx-auto">
                أداة سهلة لإزالة خلفية أي صورة تلقائياً والحصول على صورة بخلفية شفافة
            </p>
        </header>

        <!-- المحتوى الرئيسي -->
        <div class="card p-6">
            <!-- منطقة التحميل -->
            <div id="uploadSection" class="section">
                <h2 class="section-title">
                    <i class="fas fa-upload text-purple-500"></i>
                    اختيار الصورة
                </h2>
                <div id="dropZone" class="drop-zone p-8 mb-4 flex flex-col items-center justify-center cursor-pointer">
                    <i class="fas fa-cloud-upload-alt text-gray-500 text-6xl mb-4"></i>
                    <div class="text-center">
                        <p class="text-lg font-medium mb-1">اسحب واترك الصورة هنا</p>
                        <p class="text-sm text-gray-400 mb-4">أو انقر لاختيار ملف</p>
                        <button id="selectFileBtn" class="btn btn-primary">
                            <i class="fas fa-image ml-2"></i>
                            اختر صورة
                        </button>
                    </div>
                    <input type="file" id="fileInput" accept="image/*" class="hidden">
                </div>
            </div>

            <div id="editorContainer" class="hidden">
                <!-- إعدادات المعالجة -->
                <div class="section">
                    <h2 class="section-title">
                        <i class="fas fa-sliders-h text-purple-500"></i>
                        إعدادات المعالجة
                    </h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                        <div>
                            <label class="block text-sm font-medium mb-2 text-gray-300">دقة إزالة الخلفية</label>
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm text-gray-400">عادية</span>
                                <span id="toleranceValueDisplay" class="text-purple-400 font-semibold">15%</span>
                                <span class="text-sm text-gray-400">عالية</span>
                            </div>
                            <input type="range" id="toleranceSlider" class="settings-slider" min="1" max="50" value="15">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-2 text-gray-300">لون الخلفية الجديدة</label>
                            <div class="flex items-center space-x-3 rtl:space-x-reverse">
                                <div class="color-option active" data-color="transparent" style="background-image: linear-gradient(45deg, #ccc 25%, transparent 25%), linear-gradient(-45deg, #ccc 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #ccc 75%), linear-gradient(-45deg, transparent 75%, #ccc 75%); background-size: 12px 12px; background-position: 0 0, 0 6px, 6px -6px, -6px 0px;"></div>
                                <div class="color-option" data-color="#ffffff" style="background-color: #ffffff;"></div>
                                <div class="color-option" data-color="#000000" style="background-color: #000000;"></div>
                                <div class="color-option" data-color="#3b82f6" style="background-color: #3b82f6;"></div>
                                <div class="color-option" data-color="#10b981" style="background-color: #10b981;"></div>
                                <div class="color-option" data-color="#ef4444" style="background-color: #ef4444;"></div>
                                <span class="text-gray-400 text-sm mr-2">لون الخلفية:</span>
                                <div id="bgColorPreview" class="color-preview"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex justify-center">
                        <button id="applyBtn" class="btn btn-primary">
                            <i class="fas fa-magic ml-2"></i>
                            إزالة الخلفية
                        </button>
                    </div>
                </div>

                <!-- معاينة الصورة -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- الصورة الأصلية -->
                    <div class="section">
                        <h2 class="section-title">
                            <i class="fas fa-image text-purple-500"></i>
                            الصورة الأصلية
                        </h2>
                        <div id="originalPreview" class="flex justify-center items-center p-4 bg-gray-800 rounded-lg overflow-hidden"></div>
                    </div>
                    
                    <!-- النتيجة -->
                    <div class="section">
                        <h2 class="section-title">
                            <i class="fas fa-check-circle text-green-500"></i>
                            النتيجة
                        </h2>
                        <div id="resultContainer" class="relative">
                            <div id="resultPreview" class="result-container flex justify-center items-center p-4">
                                <p class="text-gray-400">ستظهر النتيجة هنا بعد المعالجة</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- أزرار التحكم -->
                <div class="flex flex-wrap justify-center gap-3 mt-6 mb-4">
                    <button id="newImageBtn" class="btn btn-secondary">
                        <i class="fas fa-plus ml-2"></i>
                        صورة جديدة
                    </button>
                    <button id="downloadBtn" class="btn btn-success" disabled>
                        <i class="fas fa-download ml-2"></i>
                        تحميل الصورة
                    </button>
                </div>
            </div>
            
            <!-- قسم التعليمات -->
            <div class="section mt-8">
                <h2 class="section-title">
                    <i class="fas fa-info-circle text-blue-500"></i>
                    كيفية إزالة خلفية الصورة
                </h2>
                
                <div class="mb-6">
                    <div class="step">
                        <div class="step-number">1</div>
                        <div class="step-text">
                            <p>قم برفع الصورة التي تريد إزالة خلفيتها (صيغ JPG أو PNG)</p>
                        </div>
                    </div>
                    
                    <div class="step">
                        <div class="step-number">2</div>
                        <div class="step-text">
                            <p>اضبط دقة المعالجة واختر لون الخلفية الجديدة (شفافة أو ملونة)</p>
                        </div>
                    </div>
                    
                    <div class="step">
                        <div class="step-number">3</div>
                        <div class="step-text">
                            <p>انقر على "إزالة الخلفية" وانتظر حتى تكتمل العملية</p>
                        </div>
                    </div>
                    
                    <div class="step">
                        <div class="step-number">4</div>
                        <div class="step-text">
                            <p>قم بتحميل الصورة الناتجة بصيغة PNG مع الخلفية الجديدة</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- قسم المميزات -->
            <div class="section">
                <h2 class="section-title">
                    <i class="fas fa-star text-yellow-500"></i>
                    مميزات الأداة
                </h2>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="feature-box">
                        <div class="feature-icon">
                            <i class="fas fa-bolt"></i>
                        </div>
                        <h3 class="font-bold mb-2">سرعة المعالجة</h3>
                        <p class="text-sm text-gray-400">معالجة سريعة للصور دون الحاجة لرفعها إلى خوادم خارجية</p>
                    </div>
                    
                    <div class="feature-box">
                        <div class="feature-icon">
                            <i class="fas fa-magic"></i>
                        </div>
                        <h3 class="font-bold mb-2">دقة عالية</h3>
                        <p class="text-sm text-gray-400">تقنيات متقدمة تضمن فصل الكائن عن الخلفية بدقة عالية</p>
                    </div>
                    
                    <div class="feature-box">
                        <div class="feature-icon">
                            <i class="fas fa-lock"></i>
                        </div>
                        <h3 class="font-bold mb-2">خصوصية تامة</h3>
                        <p class="text-sm text-gray-400">جميع المعالجات تتم داخل المتصفح دون مشاركة صورك مع أي طرف آخر</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- التذييل -->
        <footer class="mt-8 text-center">
            <div class="mb-4 flex justify-center space-x-4 rtl:space-x-reverse">
                <a href="https://twitter.com/_juz4" target="_blank" class="social-btn twitter-btn">
                    <i class="fab fa-twitter"></i>
                </a>
                <a href="https://t.me/jz_u4" target="_blank" class="social-btn telegram-btn">
                    <i class="fab fa-telegram-plane"></i>
                </a>
            </div>
            <p class="text-gray-400 text-sm">
                جميع الحقوق محفوظة للمطور 
                <a href="https://twitter.com/_juz4" target="_blank" class="footer-link">Rives</a>
                &copy; 2025
            </p>
        </footer>
    </div>
    
    <script>
        // المتغيرات
        let originalImage = null;
        let resultImage = null;
        let processing = false;
        let selectedBgColor = "transparent";
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        
        // عناصر واجهة المستخدم
        const fileInput = document.getElementById('fileInput');
        const dropZone = document.getElementById('dropZone');
        const selectFileBtn = document.getElementById('selectFileBtn');
        const uploadSection = document.getElementById('uploadSection');
        const editorContainer = document.getElementById('editorContainer');
        const originalPreview = document.getElementById('originalPreview');
        const resultPreview = document.getElementById('resultPreview');
        const resultContainer = document.getElementById('resultContainer');
        
        const toleranceSlider = document.getElementById('toleranceSlider');
        const toleranceValueDisplay = document.getElementById('toleranceValueDisplay');
        const bgColorPreview = document.getElementById('bgColorPreview');
        
        const applyBtn = document.getElementById('applyBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const newImageBtn = document.getElementById('newImageBtn');
        
        // خيارات لون الخلفية
        const colorOptions = document.querySelectorAll('.color-option');
        
        // تهيئة التطبيق
        function initApp() {
            // زر اختيار ملف
            selectFileBtn.addEventListener('click', () => {
                fileInput.click();
            });
            
            // معالجة اختيار ملف
            fileInput.addEventListener('change', handleFileSelect);
            
            // منطقة السحب والإفلات
            setupDropZone();
            
            // إعدادات المعالجة
            setupUIControls();
            
            // خيارات الألوان
            setupColorOptions();
            
            // أزرار التحكم
            applyBtn.addEventListener('click', removeBackground);
            downloadBtn.addEventListener('click', downloadImage);
            newImageBtn.addEventListener('click', () => {
                editorContainer.classList.add('hidden');
                uploadSection.classList.remove('hidden');
                fileInput.value = '';
                downloadBtn.disabled = true;
            });
        }
        
        // إعداد منطقة السحب والإفلات
        function setupDropZone() {
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('active');
            });
            
            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('active');
            });
            
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('active');
                
                if (e.dataTransfer.files.length) {
                    handleFileSelect({ target: { files: e.dataTransfer.files } });
                }
            });
        }
        
        // إعداد عناصر التحكم في الواجهة
        function setupUIControls() {
            // مزلق التسامح (الدقة)
            toleranceSlider.addEventListener('input', () => {
                toleranceValueDisplay.textContent = toleranceSlider.value + "%";
            });
            
            // تعيين لون الخلفية الافتراضي
            updateBgColorPreview();
        }
        
        // إعداد خيارات الألوان
        function setupColorOptions() {
            colorOptions.forEach(option => {
                option.addEventListener('click', () => {
                    // إزالة الفئة النشطة من جميع الخيارات
                    colorOptions.forEach(o => o.classList.remove('active'));
                    // إضافة الفئة النشطة إلى الخيار المحدد
                    option.classList.add('active');
                    // تحديث اللون المحدد
                    selectedBgColor = option.dataset.color;
                    // تحديث معاينة اللون
                    updateBgColorPreview();
                });
            });
        }
        
        // تحديث معاينة لون الخلفية
        function updateBgColorPreview() {
            if (selectedBgColor === "transparent") {
                bgColorPreview.style.backgroundImage = `
                    linear-gradient(45deg, #ccc 25%, transparent 25%), 
                    linear-gradient(-45deg, #ccc 25%, transparent 25%), 
                    linear-gradient(45deg, transparent 75%, #ccc 75%), 
                    linear-gradient(-45deg, transparent 75%, #ccc 75%)
                `;
                bgColorPreview.style.backgroundSize = '12px 12px';
                bgColorPreview.style.backgroundPosition = '0 0, 0 6px, 6px -6px, -6px 0px';
                bgColorPreview.style.backgroundColor = 'white';
            } else {
                bgColorPreview.style.backgroundImage = 'none';
                bgColorPreview.style.backgroundColor = selectedBgColor;
            }
        }
        
        // معالجة اختيار ملف
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file || !file.type.match('image.*')) {
                alert('يرجى اختيار ملف صورة صالح');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                originalImage = new Image();
                originalImage.onload = function() {
                    // إظهار واجهة التحرير
                    uploadSection.classList.add('hidden');
                    editorContainer.classList.remove('hidden');
                    
                    // تحديث معاينة الصورة الأصلية
                    showOriginalImage();
                    
                    // إعادة ضبط معاينة النتيجة
                    resultPreview.innerHTML = `<p class="text-gray-400">ستظهر النتيجة هنا بعد المعالجة</p>`;
                    downloadBtn.disabled = true;
                    resultImage = null;
                };
                originalImage.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }
        
        // عرض الصورة الأصلية
        function showOriginalImage() {
            if (!originalImage) return;
            
            originalPreview.innerHTML = `
                <img src="${originalImage.src}" class="preview-image">
            `;
        }
        
        // إزالة خلفية الصورة
        function removeBackground() {
            if (!originalImage || processing) return;
            
            processing = true;
            
            // إظهار مؤشر التحميل
            resultPreview.innerHTML = `
                <div class="loading-overlay">
                    <div class="text-center">
                        <div class="loading-spinner mx-auto"></div>
                        <div class="loading-text">جاري إزالة الخلفية...</div>
                    </div>
                </div>
                <img src="${originalImage.src}" class="preview-image">
            `;
            
            // الحصول على إعدادات المعالجة
            const tolerance = parseInt(toleranceSlider.value) / 100;
            
            // محاكاة تأخير المعالجة (في التطبيق الحقيقي، هنا ستكون خوارزمية فعلية لإزالة الخلفية)
            setTimeout(() => {
                removeBackgroundFromImage(tolerance);
            }, 1500);
        }
        
        // خوارزمية إزالة الخلفية (محاكاة متطورة)
        function removeBackgroundFromImage(tolerance) {
            // إنشاء قماش جديد بنفس حجم الصورة الأصلية
            const resultCanvas = document.createElement('canvas');
            const resultCtx = resultCanvas.getContext('2d');
            
            resultCanvas.width = originalImage.width;
            resultCanvas.height = originalImage.height;
            
            // رسم الصورة الأصلية على القماش
            resultCtx.drawImage(originalImage, 0, 0);
            
            // الحصول على بيانات الصورة
            const imageData = resultCtx.getImageData(0, 0, resultCanvas.width, resultCanvas.height);
            const data = imageData.data;
            
            // تحديد لون الزاوية العلوية اليسرى كلون الخلفية (افتراضياً)
            const cornerPixel = getAverageEdgeColor(data, resultCanvas.width, resultCanvas.height);
            
            // تحويل القيم إلى نطاق [0,1] للمقارنة السهلة
            const bgColor = {
                r: cornerPixel.r / 255,
                g: cornerPixel.g / 255,
                b: cornerPixel.b / 255
            };
            
            // معالجة كل بكسل في الصورة
            for (let i = 0; i < data.length; i += 4) {
                // تحويل لون البكسل الحالي إلى نطاق [0,1]
                const pixelColor = {
                    r: data[i] / 255,
                    g: data[i + 1] / 255,
                    b: data[i + 2] / 255
                };
                
                // حساب مدى تشابه هذا البكسل مع لون الخلفية
                const colorDistance = getColorDistance(pixelColor, bgColor);
                
                // تحديد الشفافية بناءً على التشابه والتسامح
                if (colorDistance < tolerance) {
                    // تعيين الشفافية بناءً على مدى التشابه مع الخلفية
                    data[i + 3] = 0; // جعل البكسل شفافاً تماماً
                } else if (colorDistance < tolerance * 1.5) {
                    // تعيين شفافية جزئية للبكسلات على الحافة
                    const alpha = Math.round(255 * ((colorDistance - tolerance) / (tolerance * 0.5)));
                    data[i + 3] = alpha;
                }
                // البكسلات الأخرى تبقى كما هي
            }
            
            // وضع البيانات المعالجة على القماش
            resultCtx.putImageData(imageData, 0, 0);
            
            // إذا اختار المستخدم لوناً غير الشفاف، أضف هذا اللون كخلفية
            if (selectedBgColor !== "transparent") {
                // إنشاء قماش أخير مع الخلفية الملونة
                const finalCanvas = document.createElement('canvas');
                const finalCtx = finalCanvas.getContext('2d');
                
                finalCanvas.width = resultCanvas.width;
                finalCanvas.height = resultCanvas.height;
                
                // ملء الخلفية باللون المحدد
                finalCtx.fillStyle = selectedBgColor;
                finalCtx.fillRect(0, 0, finalCanvas.width, finalCanvas.height);
                
                // رسم الصورة مع الخلفية الشفافة فوق الخلفية الملونة
                finalCtx.drawImage(resultCanvas, 0, 0);
                
                // استخدام القماش النهائي
                resultCanvas.width = finalCanvas.width;
                resultCanvas.height = finalCanvas.height;
                resultCtx.drawImage(finalCanvas, 0, 0);
            }
            
            // تحويل القماش إلى صورة
            resultImage = new Image();
            resultImage.onload = function() {
                // عرض النتيجة
                resultPreview.innerHTML = '';
                resultPreview.appendChild(resultImage);
                
                // إضافة زر التحميل إلى حاوية النتيجة
                const downloadButtonInResult = document.createElement('a');
                downloadButtonInResult.className = 'result-download-btn';
                downloadButtonInResult.innerHTML = '<i class="fas fa-download ml-1"></i> تحميل';
                downloadButtonInResult.href = resultCanvas.toDataURL('image/png');
                downloadButtonInResult.download = 'removed-background.png';
                resultContainer.appendChild(downloadButtonInResult);
                
                // تفعيل زر التحميل الرئيسي
                downloadBtn.disabled = false;
                
                // إنهاء حالة المعالجة
                processing = false;
            };
            resultImage.className = 'preview-image';
            resultImage.src = resultCanvas.toDataURL('image/png');
        }
        
        // الحصول على متوسط لون حواف الصورة (للتعرف على الخلفية)
        function getAverageEdgeColor(data, width, height) {
            const edgePixels = [];
            const sampleSize = 10; // أخذ عينات من كل 10 بكسلات في الحواف
            
            // أخذ عينات من الحافة العلوية
            for (let x = 0; x < width; x += sampleSize) {
                const i = (0 * width + x) * 4;
                edgePixels.push({ r: data[i], g: data[i + 1], b: data[i + 2] });
            }
            
            // أخذ عينات من الحافة السفلية
            for (let x = 0; x < width; x += sampleSize) {
                const i = ((height - 1) * width + x) * 4;
                edgePixels.push({ r: data[i], g: data[i + 1], b: data[i + 2] });
            }
            
            // أخذ عينات من الحافة اليسرى
            for (let y = 0; y < height; y += sampleSize) {
                const i = (y * width + 0) * 4;
                edgePixels.push({ r: data[i], g: data[i + 1], b: data[i + 2] });
            }
            
            // أخذ عينات من الحافة اليمنى
            for (let y = 0; y < height; y += sampleSize) {
                const i = (y * width + (width - 1)) * 4;
                edgePixels.push({ r: data[i], g: data[i + 1], b: data[i + 2] });
            }
            
            // حساب متوسط الألوان
            let totalR = 0, totalG = 0, totalB = 0;
            
            for (const pixel of edgePixels) {
                totalR += pixel.r;
                totalG += pixel.g;
                totalB += pixel.b;
            }
            
            return {
                r: Math.round(totalR / edgePixels.length),
                g: Math.round(totalG / edgePixels.length),
                b: Math.round(totalB / edgePixels.length)
            };
        }
        
        // حساب المسافة بين لونين (مقياس التشابه)
        function getColorDistance(color1, color2) {
            const rDiff = color1.r - color2.r;
            const gDiff = color1.g - color2.g;
            const bDiff = color1.b - color2.b;
            
            // مقياس المسافة الإقليدية (للتشابه)
            return Math.sqrt(rDiff*rDiff + gDiff*gDiff + bDiff*bDiff);
        }
        
        // تحميل الصورة النهائية
        function downloadImage() {
            if (!resultImage) return;
            
            // إنشاء رابط تنزيل
            const link = document.createElement('a');
            link.download = 'removed-background.png';
            link.href = resultImage.src;
            link.click();
        }
        
        // تهيئة التطبيق عند تحميل الصفحة
        window.onload = initApp;
    </script>
</body>
</html>
